#include <stdbool.h>
#include <stddef.h>
#include <stdint.h>


/* Created libraries */
#include "driver_keyboard.h"
#include "driver_video.h"
#include "commands.h"
#include "interrupts.h"
#include "string.h"
#include "math.h"
#include "register.h"

/*
To compile:
* Comment the pre processor directives and run the command below:
i686-linux-gnu-gcc-10 -c kernel.c -o kernel.o -std=gnu99 -ffreestanding -O2 -Wall -Wextra
*/

extern void _run_app();

void kernel_main(void){
	gdt_config();
	idt_config();
	isr_config();


	/* Initialize terminal interface */
	terminal_initialize();



uint16_t prog[] = {0xb866,0x0004,0x0000,0xbb66,0x0001,0x0000,0xb966,0x0028,
0x0000,0xba66,0x000d,0x0000,0x80cd,0xb866,0x0001,0x0000,
0xbb66,0x0000,0x0000,0x80cd,0x6548,0x6c6c,0x206f,0x6f77,
0x6c72,0x2164,0x000a};
	/*uint8_t prog[] = {0xcd,0x80,0x00,0x00,0x00,0x00,0x66,0xbb,
0x00,0x00,0x01,0x00,0x66,0xb8,0xcd,0x80,
0x00,0x00,0x0d,0x00,0x66,0xba,0x00,0x00,
0x00,0x00,0x66,0xb9,0x00,0x00,0x01,0x00,
0x66,0xbb,0x00,0x00,0x04,0x00,0x66,0xb8,
0x00,0x00,0x0a,0x00,0x64,0x21,0x72,0x6c,
0x77,0x6f,0x6f,0x20,0x6c,0x6c,0x48,0x65};*/
	//uint8_t prog[] = {0xcd,0x80,0x00,0x00,0x00,0x00,0x66,0xbb,
//0x00,0x00,0x01,0x00,0x66,0xb8,0xcd,0x80,
//0x00,0x00,0x0d,0x00,0x66,0xba,0x00,0x00,
//0x00,0x00,0x66,0xb9,0x00,0x00,0x01,0x00,/
//0x66,0xbb,0x00,0x00,0x04,0x00,0x66,0xb8,
//0x00,0x00,0x00,0x0a,0x21,0x64,0x6c,0x72,
//0x6f,0x77,0x20,0x6f,0x6c,0x6c,0x65,0x48};
	//terminal_writenum((size_t)&prog,16);
	terminal_putchar('\n');
	uint16_t *c = (uint16_t *)0x2000;
	//terminal_writenum(0x2000,10);
	for(uint16_t i = 0; i < 28; i++){
		c[i] = prog[i];
	}


	_run_app();




	//terminal_writestring("Hello, I'm a simple kernel!\n\0");

	while(true){

		//terminal_putchar(translate(inb(0x60))); // For collect keyboard codes of each key pressed
		//terminal_readString(buffer);
		//terminal_writestring("Hello, I'm a simple kernel2!\n\0");
		//terminal_writestring(buffer); // To check if the buffer gets the right input
		//command(buffer);
	}
}